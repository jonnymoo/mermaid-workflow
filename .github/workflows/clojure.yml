name: Clojure CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Java
      uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: Cache .m2 directory
      uses: actions/cache@v2
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run tests
      working-directory: ./mermaid-processor
      run: |
        lein deps
        lein test

    - name: Install clj-kondo
      run: |
        mkdir -p $HOME/bin
        curl -L https://github.com/clj-kondo/clj-kondo/releases/download/v2023.10.20/clj-kondo-2023.10.20-linux-amd64.zip -o clj-kondo.zip
        sudo apt-get update
        sudo apt-get install -y unzip
        unzip clj-kondo.zip -d $HOME/bin
        chmod +x $HOME/bin/clj-kondo
        rm clj-kondo.zip

    - name: Lint with clj-kondo
      working-directory: ./mermaid-processor
      run: 
        $HOME/bin/clj-kondo --lint src
